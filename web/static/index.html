<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>File Renamer Web UI</title>
    <style>
      body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
        margin: 0; 
        padding: 12px; 
        min-height: 100vh;
        background: #0b0d10;
        color: #e6edf3;
        line-height: 1.6;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
      }
      fieldset { 
        border: 1px solid #30363d; 
        padding: 16px; 
        border-radius: 8px; 
        margin-bottom: 0;
        background: #161b22;
      }
      legend { 
        color: #f78166; 
        font-weight: 600;
        font-size: 16px;
        padding: 0 12px;
        margin-bottom: 16px;
        border-bottom: 2px solid #f78166;
        padding-bottom: 8px;
      }
      label { 
        display: block; 
        margin: 12px 0 8px 0; 
        font-weight: 500;
        color: #c9d1d9;
        font-size: 14px;
      }
      input[type=text], input[type=number], select { 
        width: 100%; 
        padding: 8px 12px; 
        background: #0e1116; 
        border: 1px solid #30363d; 
        color: #e6edf3; 
        border-radius: 6px;
        font-size: 14px;
      }
      input[type=text]:focus, input[type=number]:focus, select:focus {
        border-color: #58a6ff;
        outline: none;
      }
      input[type=text]::placeholder, input[type=number]::placeholder {
        color: #8b949e;
      }
      input[type=checkbox] { 
        width: 18px; 
        height: 18px; 
        cursor: pointer; 
        margin: 0 8px 0 0;
        accent-color: #58a6ff;
        border-radius: 4px;
      }
      .main-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 16px;
      }
      @media (max-width: 1024px) {
        .main-layout {
          grid-template-columns: 1fr;
          gap: 16px;
        }
      }
      .actions { 
        display: flex; 
        gap: 12px; 
        margin-top: 24px;
        justify-content: center;
      }
      button { 
        background: #238636;
        color: white; 
        border: none; 
        padding: 10px 20px; 
        border-radius: 6px; 
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
      }
      button:hover {
        background: #2ea043;
      }
      button.secondary { 
        background: #30363d; 
      }
      button.secondary:hover {
        background: #484f58;
      }
      button.warn { 
        background: #d29922; 
      }
      button.warn:hover {
        background: #bb8009;
      }
      button:disabled { 
        opacity: 0.6; 
        cursor: not-allowed;
      }
      pre { 
        background: #0e1116;
        border: 1px solid #30363d;
        padding: 16px; 
        border-radius: 8px; 
        height: 500px; 
        overflow: auto; 
        white-space: pre-wrap;
        font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
        font-size: 13px;
        line-height: 1.5;
      }
      summary {
        cursor: pointer;
        font-weight: 500;
        color: #58a6ff;
        padding: 8px 0;
        margin-bottom: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="main-layout">
        <fieldset>
          <legend>基本设置</legend>
      <div class="row" style="row-gap:14px; column-gap:18px;">
        <div>
          <label>目录路径</label>
          <div style="display:flex; gap:8px;">
            <input id="directory" type="text" placeholder="例如：D:\Downloads" style="flex:1;" />
            <button id="btnBrowse" class="secondary">选择...</button>
          </div>
          <small class="hint">请输入本机磁盘中的文件夹路径，或使用“选择...”打开文件夹对话框</small>
        </div>
        <div>
          <label>算法</label>
          <select id="algorithm">
            <option>MD5</option>
            <option>SHA1</option>
            <option>SHA256</option>
            <option>SHA512</option>
            <option>CRC32</option>
            <option>BLAKE2B</option>
          </select>
        </div>
      </div>
  <div class="row" style="margin-top:12px;">
        <div>
          <label>模式</label>
          <select id="mode">
            <option value="multi-thread">Multi Thread (默认)</option>
            <option value="batch-mode">Batch Mode</option>
            <option value="single-thread">Single Thread</option>
          </select>
        </div>
        <div style="margin-right: 24px;">
          <label>扩展名过滤（逗号分隔）</label>
          <input id="extensions" type="text" value="jpg,jpeg,png" placeholder="jpg,png,txt 或 .jpg,.png,.txt" />
        </div>
      </div>

  <div class="row" style="margin-top:12px; gap:16px;">
        <div style="margin-right: 16px;">
          <label style="display: flex; align-items: center; margin: 6px 0; cursor: pointer; padding: 8px; border-radius: 6px; transition: background-color 0.2s ease;">
            <input id="execute" type="checkbox" />
            <span>执行重命名（默认预览）</span>
          </label>
        </div>
        <div style="margin-right: 16px;">
          <label style="display: flex; align-items: center; margin: 6px 0; cursor: pointer; padding: 8px; border-radius: 6px; transition: background-color 0.2s ease;">
            <input id="recursive" type="checkbox" />
            <span>包含子目录</span>
          </label>
        </div>
      </div>

  <details style="margin-top:12px;">
        <summary>高级参数（可选）</summary>
  <div class="row4" style="margin-top:12px; gap:16px;">
          <div style="margin-right: 16px;">
            <label>线程数</label>
            <input id="threads" type="number" min="1" placeholder="留空=自动" />
          </div>
          <div style="margin-right: 16px;">
            <label>批大小</label>
            <input id="batch" type="number" min="1" placeholder="留空=自动" />
          </div>
          <div style="margin-right: 16px;">
            <label>缓冲KB</label>
            <input id="buffer_kb" type="number" min="1" placeholder="自动" />
            <small class="hint">哈希计算的流式缓冲区大小（KB），用于文件读取优化，默认自动</small>
          </div>
          <div style="margin-right: 16px;">
            <label>mmap块MB</label>
            <input id="mmap_chunk_mb" type="number" min="1" placeholder="自动" />
            <small class="hint">内存映射文件块大小（MB），用于大文件处理优化，默认自动</small>
          </div>
        </div>
      </details>

      <div class="actions" style="margin-top:12px;">
        <button id="run">运行</button>
        <button id="stop" class="warn" disabled>停止</button>
        <button id="clear" class="secondary">清空输出</button>
      </div>
        </fieldset>

        <fieldset>
          <legend>输出</legend>
          <pre id="output"></pre>
        </fieldset>
      </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const out = $("output");
      const btnRun = $("run");
      const btnStop = $("stop");
      const btnClear = $("clear");

      const modeSelect = $("mode");
      const threadsInput = $("threads");


      const btnBrowse = $("btnBrowse");
      btnBrowse.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          const res = await fetch('/api/browse-folder');
          const j = await res.json();
          if (!res.ok) {
            if (j && j.error === 'cancelled') return; // user cancelled dialog
            alert('选择目录失败：' + (j.error || res.statusText));
            return;
          }
          if (j.path) {
            $("directory").value = j.path;
          }
        } catch (err) {
          const msg = (err && err.message) ? err.message : (typeof err === 'string' ? err : JSON.stringify(err));
          alert('请求文件夹选择失败：' + msg);
        }
      });

      function collectPayload() {
        return {
          directory: $("directory").value,
          algorithm: $("algorithm").value,
          mode: $("mode").value,
          // Device selection removed - CPU processing only
          extensions: $("extensions").value,
          threads: $("threads").value,
          batch: $("batch").value,
          execute: $("execute").checked,
          yes: $("execute").checked, // auto-confirm when execute
          recursive: $("recursive").checked,
          buffer_kb: $("buffer_kb").value,
          mmap_chunk_mb: $("mmap_chunk_mb").value,
        };
      }

      function append(text) {
        out.textContent += text;
        out.scrollTop = out.scrollHeight;
      }

      btnClear.addEventListener('click', () => { out.textContent = ''; });

      btnRun.addEventListener('click', async () => {
        const payload = collectPayload();
        if (!payload.directory) { alert('请填写目录路径'); return; }
        out.textContent = '';
        btnRun.disabled = true; btnStop.disabled = false;
        try {
          const res = await fetch('/api/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const j = await res.json().catch(() => ({}));
            append('启动失败：' + (j.error || res.statusText) + '\n');
          } else {
            const reader = res.body.getReader();
            const decoder = new TextDecoder('utf-8');
            while (true) {
              const { value, done } = await reader.read();
              if (done) break;
              append(decoder.decode(value));
            }
          }
        } catch (e) {
          const msg = (e && e.message) ? e.message : (typeof e === 'string' ? e : JSON.stringify(e));
          append('请求失败：' + msg + '\n');
        } finally {
          btnRun.disabled = false; btnStop.disabled = true;
        }
      });

      btnStop.addEventListener('click', async () => {
        btnStop.disabled = true;
        try {
          await fetch('/api/stop', { method: 'POST' });
        } catch {}
      });
    </script>
    </div>
  </body>
  </html>
