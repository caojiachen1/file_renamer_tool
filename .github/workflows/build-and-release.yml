name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€å½¢å¦‚ v1.0.0 çš„æ ‡ç­¾
    branches:
      - main
      - master  # æ”¯æŒé€šè¿‡commitä¿¡æ¯è‡ªåŠ¨è§¦å‘release
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬æ›´æ–°ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (ä¾‹å¦‚: v2.0.1, ç•™ç©ºåˆ™è‡ªåŠ¨é€’å¢)'
        required: false
        default: ''

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup CMake
      uses: lukka/get-cmake@latest
      
    - name: Setup CUDA 12.8
      uses: Jimver/cuda-toolkit@v0.2.26
      with:
        cuda: '12.8.0'
        method: 'network'
        use-github-cache: false
        log-file-suffix: 'cuda-install.log'
        
    - name: Verify CUDA installation
      shell: pwsh
      run: |
        Write-Host "æ£€æŸ¥CUDAå®‰è£…..."
        try {
          $nvcc_version = nvcc --version
          Write-Host "NVCCç‰ˆæœ¬ä¿¡æ¯:"
          Write-Host $nvcc_version
          
          # æ£€æŸ¥CUDAè·¯å¾„
          if ($env:CUDA_PATH) {
            Write-Host "CUDA_PATH: $env:CUDA_PATH"
          }
          
          if ($env:CUDA_HOME) {
            Write-Host "CUDA_HOME: $env:CUDA_HOME"
          }
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          $cuda_lib = "$env:CUDA_PATH\lib\x64"
          if (Test-Path $cuda_lib) {
            Write-Host "âœ“ CUDAåº“ç›®å½•å­˜åœ¨: $cuda_lib"
          } else {
            Write-Host "âš  CUDAåº“ç›®å½•ä¸å­˜åœ¨: $cuda_lib"
          }
          
          $cuda_include = "$env:CUDA_PATH\include"
          if (Test-Path $cuda_include) {
            Write-Host "âœ“ CUDAå¤´æ–‡ä»¶ç›®å½•å­˜åœ¨: $cuda_include"
          } else {
            Write-Host "âš  CUDAå¤´æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨: $cuda_include"
          }
          
        } catch {
          Write-Error "CUDAéªŒè¯å¤±è´¥: $($_.Exception.Message)"
          exit 1
        }
      
    - name: Get version from tag or input
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          # æ‰‹åŠ¨è§¦å‘çš„æƒ…å†µ
          $custom_version = "${{ github.event.inputs.custom_version }}"
          
          if ($custom_version -and $custom_version.Trim() -ne "") {
            # ä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬å·
            $version = $custom_version.Trim()
            Write-Host "ä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬å·: $version"
          } else {
            # è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·
            $version_type = "${{ github.event.inputs.version_type }}"
            Write-Host "ç‰ˆæœ¬æ›´æ–°ç±»å‹: $version_type"
            
            # ä½¿ç”¨GitHub APIè·å–æœ€æ–°çš„release
            try {
              $headers = @{
                'Authorization' = 'token ${{ secrets.GITHUB_TOKEN }}'
                'Accept' = 'application/vnd.github.v3+json'
              }
              
              $response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest" -Headers $headers -ErrorAction SilentlyContinue
              
              if ($response -and $response.tag_name) {
                $latest_tag = $response.tag_name
                Write-Host "é€šè¿‡APIæ‰¾åˆ°æœ€æ–°releaseæ ‡ç­¾: $latest_tag"
              } else {
                # å¦‚æœæ²¡æœ‰releaseï¼Œå°è¯•è·å–æœ€æ–°çš„tag
                $tags_response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/tags" -Headers $headers -ErrorAction SilentlyContinue
                if ($tags_response -and $tags_response.Length -gt 0) {
                  $latest_tag = $tags_response[0].name
                  Write-Host "é€šè¿‡APIæ‰¾åˆ°æœ€æ–°æ ‡ç­¾: $latest_tag"
                } else {
                  $latest_tag = "v2.0.0"
                  Write-Host "æœªæ‰¾åˆ°ä»»ä½•æ ‡ç­¾ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $latest_tag"
                }
              }
            } catch {
              # å›é€€åˆ°gitå‘½ä»¤
              Write-Host "APIè°ƒç”¨å¤±è´¥ï¼Œå›é€€åˆ°gitå‘½ä»¤"
              $latest_tag = git describe --tags --abbrev=0 2>$null
              if (-not $latest_tag) {
                $latest_tag = "v2.0.0"
                Write-Host "æœªæ‰¾åˆ°ç°æœ‰æ ‡ç­¾ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $latest_tag"
              } else {
                Write-Host "é€šè¿‡gitæ‰¾åˆ°æœ€æ–°æ ‡ç­¾: $latest_tag"
              }
            }
            
            # è§£æç‰ˆæœ¬å·
            if ($latest_tag -match '^v(\d+)\.(\d+)\.(\d+)$') {
              $major = [int]$matches[1]
              $minor = [int]$matches[2]
              $patch = [int]$matches[3]
              
              # æ ¹æ®ç±»å‹é€’å¢ç‰ˆæœ¬å·
              switch ($version_type) {
                "major" { 
                  $major++
                  $minor = 0
                  $patch = 0
                }
                "minor" { 
                  $minor++
                  $patch = 0
                }
                "patch" { 
                  $patch++
                }
              }
              
              $version = "v$major.$minor.$patch"
              Write-Host "è‡ªåŠ¨é€’å¢åçš„ç‰ˆæœ¬: $version"
            } else {
              Write-Error "æ— æ³•è§£æç‰ˆæœ¬å·æ ¼å¼: $latest_tag"
              exit 1
            }
          }
        } else {
          # æ¨é€è§¦å‘çš„æƒ…å†µ (æ ‡ç­¾æ¨é€æˆ–åˆ†æ”¯æ¨é€)
          if ("${{ github.ref_type }}" -eq "tag") {
            # æ ‡ç­¾æ¨é€è§¦å‘
            $version = "${{ github.ref_name }}"
            Write-Host "ä»æ ‡ç­¾è·å–ç‰ˆæœ¬: $version"
          } else {
            # åˆ†æ”¯æ¨é€è§¦å‘ - æ£€æŸ¥commitä¿¡æ¯æ¥ç¡®å®šæ˜¯å¦éœ€è¦è‡ªåŠ¨å‘å¸ƒ
            $commit_message = git log -1 --pretty=format:"%s%n%b"
            Write-Host "æ£€æŸ¥commitä¿¡æ¯: $commit_message"
            
            # æ£€æŸ¥commitä¿¡æ¯ä¸­çš„ç‰ˆæœ¬æ§åˆ¶å…³é”®è¯
            $auto_version_type = $null
            
            # ä¼˜å…ˆæ£€æŸ¥æœ«å°¾çš„[]æ ‡è®°
            if ($commit_message -match '\[major\]$') {
              $auto_version_type = "major"
            } elseif ($commit_message -match '\[minor\]$') {
              $auto_version_type = "minor"
            } elseif ($commit_message -match '\[patch\]$') {
              $auto_version_type = "patch"
            }
            # å¦‚æœæ²¡æœ‰[]æ ‡è®°ï¼Œå†æ£€æŸ¥å…¶ä»–å…³é”®è¯
            elseif ($commit_message -match '\bmajor:|\bbreaking\s*change|\bBREAKING\s*CHANGE') {
              $auto_version_type = "major"
            } elseif ($commit_message -match '\bminor:|\bfeat:|\bfeature:') {
              $auto_version_type = "minor"
            } elseif ($commit_message -match '\bpatch:|\bfix:|\bbugfix:') {
              $auto_version_type = "patch"
            }
            
            if (-not $auto_version_type) {
              Write-Host "commitä¿¡æ¯ä¸­æœªæ‰¾åˆ°ç‰ˆæœ¬æ§åˆ¶å…³é”®è¯ï¼Œè·³è¿‡è‡ªåŠ¨å‘å¸ƒ"
              Write-Host "æ”¯æŒçš„æ ‡è®°æ ¼å¼:"
              Write-Host "  - æ¶ˆæ¯æœ«å°¾: [major], [minor], [patch]"
              Write-Host "  - å‰ç¼€å…³é”®è¯: major:, minor:, patch:, feat:, fix:, etc."
              Write-Host "å½“å‰commit: $commit_message"
              exit 0
            }
            
            Write-Host "ä»commitä¿¡æ¯æ£€æµ‹åˆ°ç‰ˆæœ¬ç±»å‹: $auto_version_type"
            
            # ä½¿ç”¨GitHub APIè·å–æœ€æ–°çš„releaseæ¥è‡ªåŠ¨è®¡ç®—ç‰ˆæœ¬
            try {
              $headers = @{
                'Authorization' = 'token ${{ secrets.GITHUB_TOKEN }}'
                'Accept' = 'application/vnd.github.v3+json'
              }
              
              $response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest" -Headers $headers -ErrorAction SilentlyContinue
              
              if ($response -and $response.tag_name) {
                $latest_tag = $response.tag_name
                Write-Host "é€šè¿‡APIæ‰¾åˆ°æœ€æ–°releaseæ ‡ç­¾: $latest_tag"
              } else {
                # å¦‚æœæ²¡æœ‰releaseï¼Œå°è¯•è·å–æœ€æ–°çš„tag
                $tags_response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/tags" -Headers $headers -ErrorAction SilentlyContinue
                if ($tags_response -and $tags_response.Length -gt 0) {
                  $latest_tag = $tags_response[0].name
                  Write-Host "é€šè¿‡APIæ‰¾åˆ°æœ€æ–°æ ‡ç­¾: $latest_tag"
                } else {
                  $latest_tag = "v2.0.0"
                  Write-Host "æœªæ‰¾åˆ°ä»»ä½•æ ‡ç­¾ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $latest_tag"
                }
              }
              
              # è§£æå¹¶é€’å¢ç‰ˆæœ¬å·
              if ($latest_tag -match '^v(\d+)\.(\d+)\.(\d+)$') {
                $major = [int]$matches[1]
                $minor = [int]$matches[2]
                $patch = [int]$matches[3]
                
                switch ($auto_version_type) {
                  "major" { 
                    $major++
                    $minor = 0
                    $patch = 0
                  }
                  "minor" { 
                    $minor++
                    $patch = 0
                  }
                  "patch" { 
                    $patch++
                  }
                }
                
                $version = "v$major.$minor.$patch"
                Write-Host "åŸºäºcommitä¿¡æ¯è‡ªåŠ¨é€’å¢ç‰ˆæœ¬: $latest_tag â†’ $version"
              } else {
                Write-Error "æ— æ³•è§£æç‰ˆæœ¬å·æ ¼å¼: $latest_tag"
                exit 1
              }
            } catch {
              Write-Error "APIè°ƒç”¨å¤±è´¥ï¼Œæ— æ³•è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬"
              exit 1
            }
          }
        }
        
        # ç¡®ä¿ç‰ˆæœ¬æ ¼å¼æ­£ç¡® (vä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬)
        if ($version -notmatch '^v\d+\.\d+\.\d+$') {
          Write-Error "ç‰ˆæœ¬æ ¼å¼é”™è¯¯ã€‚è¯·ä½¿ç”¨ vä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬ æ ¼å¼ (ä¾‹å¦‚: v2.0.1)"
          Write-Error "å½“å‰ç‰ˆæœ¬: $version"
          exit 1
        }
        
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Output "version_number=$($version.Substring(1))" >> $env:GITHUB_OUTPUT
        Write-Host "æœ€ç»ˆç‰ˆæœ¬: $version"
        
    - name: Update version in CMakeLists.txt
      shell: pwsh
      run: |
        $version_number = "${{ steps.version.outputs.version_number }}"
        $cmake_content = Get-Content CMakeLists.txt -Raw
        $cmake_content = $cmake_content -replace 'project\(FileRenamerTool VERSION \d+\.\d+\.\d+', "project(FileRenamerTool VERSION $version_number"
        Set-Content CMakeLists.txt $cmake_content
        Write-Host "å·²æ›´æ–° CMakeLists.txt ä¸­çš„ç‰ˆæœ¬å·ä¸º: $version_number"
        
    - name: Create and push tag (for manual trigger and auto release)
      if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref_type == 'branch')
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        
        # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        $existing_tag = git tag -l $version
        if ($existing_tag) {
          Write-Host "æ ‡ç­¾ $version å·²å­˜åœ¨ï¼Œå¤ç”¨ç°æœ‰æ ‡ç­¾"
          # æ£€æŸ¥è¿œç¨‹æ˜¯å¦ä¹Ÿå­˜åœ¨è¯¥æ ‡ç­¾
          $remote_tag = git ls-remote --tags origin $version
          if (-not $remote_tag) {
            Write-Host "è¿œç¨‹ä¸å­˜åœ¨æ ‡ç­¾ $versionï¼Œæ¨é€åˆ°è¿œç¨‹"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git push origin $version
          } else {
            Write-Host "è¿œç¨‹ä¹Ÿå­˜åœ¨æ ‡ç­¾ $versionï¼Œç›´æ¥å¤ç”¨"
          }
        } else {
          Write-Host "åˆ›å»ºæ–°æ ‡ç­¾: $version"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag $version
          git push origin $version
          Write-Host "æ ‡ç­¾ $version å·²åˆ›å»ºå¹¶æ¨é€"
        }
        
    - name: Build project
      shell: cmd
      run: |
        echo å¼€å§‹æ„å»ºé¡¹ç›® (å¯ç”¨CUDA 12.8)...
        
        echo é…ç½®CMake (å¯ç”¨CUDA)...
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DUSE_CUDA=ON
        if %errorlevel% neq 0 (
          echo CMakeé…ç½®å¤±è´¥ï¼
          exit /b %errorlevel%
        )
        
        echo ç¼–è¯‘é¡¹ç›®...
        cmake --build build --config Release --verbose
        if %errorlevel% neq 0 (
          echo æ„å»ºå¤±è´¥ï¼
          exit /b %errorlevel%
        )
        
        echo å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åˆ°æ ¹ç›®å½•...
        copy "build\Release\file_renamer_cli.exe" "file_renamer.exe" >nul 2>&1
        if exist "build\Release\file_renamer_cli.exe" (
          echo âœ“ CUDAç‰ˆæœ¬æ„å»ºå®Œæˆï¼
        ) else (
          echo âœ— æœªæ‰¾åˆ°æ„å»ºäº§ç‰©ï¼
          exit /b 1
        )
        
    - name: Verify build artifacts
      shell: pwsh
      run: |
        Write-Host "æ£€æŸ¥æ„å»ºäº§ç‰©..."
        
        $release_exe = "build\Release\file_renamer_cli.exe"
        $root_exe = "file_renamer.exe"
        $debug_exe = "build\Debug\file_renamer_cli.exe"
        
        if (Test-Path $release_exe) {
          Write-Host "âœ“ æ‰¾åˆ° Release ç‰ˆæœ¬: $release_exe"
          $size = (Get-Item $release_exe).Length
          Write-Host "  æ–‡ä»¶å¤§å°: $([math]::Round($size/1KB, 2)) KB"
        } else {
          Write-Error "âœ— æœªæ‰¾åˆ° Release ç‰ˆæœ¬: $release_exe"
          exit 1
        }
        
        if (Test-Path $debug_exe) {
          Write-Host "âœ“ æ‰¾åˆ° Debug ç‰ˆæœ¬: $debug_exe"
        } else {
          Write-Host "âš  æœªæ‰¾åˆ° Debug ç‰ˆæœ¬: $debug_exe"
        }
        
        if (Test-Path $root_exe) {
          Write-Host "âœ“ æ‰¾åˆ°æ ¹ç›®å½•å‰¯æœ¬: $root_exe"
        } else {
          Write-Host "âš  æœªæ‰¾åˆ°æ ¹ç›®å½•å‰¯æœ¬: $root_exe"
        }
        
    - name: Prepare release assets
      shell: pwsh
      run: |
        Write-Host "å‡†å¤‡å‘å¸ƒæ–‡ä»¶ (CUDAç‰ˆæœ¬)..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "release-assets"
        
        # å¤åˆ¶ä¸»è¦å¯æ‰§è¡Œæ–‡ä»¶ (CUDAç‰ˆæœ¬)
        $version = "${{ steps.version.outputs.version }}"
        $release_name = "file_renamer_cli_$($version)_windows_x64_cuda12.8.exe"
        Copy-Item "build\Release\file_renamer_cli.exe" "release-assets\$release_name"
        
        Write-Host "å‘å¸ƒæ–‡ä»¶å‡†å¤‡å®Œæˆï¼š"
        Get-ChildItem "release-assets" | ForEach-Object {
          Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1KB, 2)) KB)"
        }
        
    - name: Create release notes
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        
        # è·å–æœ€æ–°çš„commitä¿¡æ¯
        $commit_message = git log -1 --pretty=format:"%s"
        $commit_body = git log -1 --pretty=format:"%b"
        $commit_hash = git log -1 --pretty=format:"%h"
        
        # åˆ›å»ºç®€æ´çš„å‘å¸ƒè¯´æ˜
        $content = @()
        $content += "## ğŸ“¦ File Renamer CLI Tool $version (CUDA 12.8)"
        $content += ""
        $content += "ğŸš€ **GPUåŠ é€Ÿç‰ˆæœ¬** - æ”¯æŒNVIDIA GPUå¹¶è¡Œè®¡ç®—ï¼Œæ˜¾è‘—æå‡å¤§æ–‡ä»¶æ‰¹é‡é‡å‘½åæ€§èƒ½"
        $content += ""
        
        # æ·»åŠ commitä¿¡æ¯
        if ($commit_message) {
          $content += "- $commit_message"
          if ($commit_body -and $commit_body.Trim() -ne "") {
            $commit_body.Split("`n") | ForEach-Object {
              if ($_.Trim() -ne "") {
                $content += "- $($_.Trim())"
              }
            }
          }
          $content += ""
          $content += "*Commit: $commit_hash*"
          $content += ""
        }
        
        # æ·»åŠ ä½¿ç”¨è¯´æ˜
        $content += "ä½¿ç”¨æ–¹æ³•"
        $content += ""
        $content += "**é¢„è§ˆæ¨¡å¼**"
        $content += '```cmd'
        $content += 'file_renamer.exe "C:\MyFiles" -x jpg,png'
        $content += '```'
        $content += ""
        $content += "**æ‰§è¡Œé‡å‘½åï¼š**"
        $content += '```cmd'
        $content += 'file_renamer.exe "C:\MyFiles" -x jpg,png -e'
        $content += '```'
        $content += ""
        $content += "**æ›´å¤šé€‰é¡¹ï¼š**"
        $content += '```cmd'
        $content += 'file_renamer.exe --help'
        $content += '```'
        $content += ""
        $content += "ç³»ç»Ÿè¦æ±‚"
        $content += "- Windows 10/11 (x64)"
        $content += "- NVIDIA GPU (å¯é€‰ï¼Œç”¨äºGPUåŠ é€Ÿ)"
        $content += "- CUDA 12.8å…¼å®¹çš„æ˜¾å¡é©±åŠ¨"
        $content += ""
        $content += "**æ³¨æ„ï¼š** å¦‚æœç³»ç»Ÿæ²¡æœ‰å…¼å®¹çš„NVIDIA GPUï¼Œç¨‹åºä¼šè‡ªåŠ¨å›é€€åˆ°CPUæ¨¡å¼è¿è¡Œ"
        
        $content | Out-File "release-notes.md" -Encoding UTF8
        Write-Host "å‘å¸ƒè¯´æ˜å·²ç”Ÿæˆ"
        
    - name: Create Release
      id: create_release
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $release_name = "File Renamer CLI Tool $version"
        
        # æ£€æŸ¥Releaseæ˜¯å¦å·²å­˜åœ¨
        try {
          $headers = @{
            'Authorization' = 'token ${{ secrets.GITHUB_TOKEN }}'
            'Accept' = 'application/vnd.github.v3+json'
          }
          
          Write-Host "æ£€æŸ¥Releaseæ˜¯å¦å­˜åœ¨: $version"
          $existing_release = $null
          
          try {
            $existing_release = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/tags/$version" -Headers $headers
            Write-Host "æ‰¾åˆ°ç°æœ‰Release: $version"
          } catch {
            if ($_.Exception.Response.StatusCode -eq 404) {
              Write-Host "Release $version ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°Release"
              $existing_release = $null
            } else {
              throw $_.Exception
            }
          }
          
          if ($existing_release) {
            Write-Host "Release $version å·²å­˜åœ¨ï¼Œå¤ç”¨ç°æœ‰Release"
            Write-Host "Release ID: $($existing_release.id)"
            Write-Host "Release URL: $($existing_release.html_url)"
            
            # è¾“å‡ºç°æœ‰Releaseä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            Write-Output "upload_url=$($existing_release.upload_url)" >> $env:GITHUB_OUTPUT
            Write-Output "html_url=$($existing_release.html_url)" >> $env:GITHUB_OUTPUT
            Write-Output "id=$($existing_release.id)" >> $env:GITHUB_OUTPUT
            Write-Output "created=false" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "åˆ›å»ºæ–°Release: $version"
            
            # è¯»å–release notes
            $body = Get-Content "release-notes.md" -Raw -Encoding UTF8
            
            $release_data = @{
              tag_name = $version
              target_commitish = "main"
              name = $release_name
              body = $body
              draft = $false
              prerelease = $false
            } | ConvertTo-Json -Depth 10
            
            $new_release = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases" -Method POST -Headers $headers -Body $release_data
            
            Write-Host "æ–°Releaseå·²åˆ›å»º"
            Write-Host "Release ID: $($new_release.id)"
            Write-Host "Release URL: $($new_release.html_url)"
            
            # è¾“å‡ºæ–°Releaseä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            Write-Output "upload_url=$($new_release.upload_url)" >> $env:GITHUB_OUTPUT
            Write-Output "html_url=$($new_release.html_url)" >> $env:GITHUB_OUTPUT
            Write-Output "id=$($new_release.id)" >> $env:GITHUB_OUTPUT
            Write-Output "created=true" >> $env:GITHUB_OUTPUT
          }
        } catch {
          Write-Error "å¤„ç†Releaseæ—¶å‡ºé”™: $($_.Exception.Message)"
          Write-Error "çŠ¶æ€ç : $($_.Exception.Response.StatusCode)"
          Write-Error "è¯¦ç»†ä¿¡æ¯: $($_.Exception.Response.StatusDescription)"
          exit 1
        }
        
    - name: Upload Release Asset - Main Executable
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $asset_name = "file_renamer_cli_$($version)_windows_x64_cuda12.8.exe"
        $asset_path = "release-assets/$asset_name"
        $upload_url = "${{ steps.create_release.outputs.upload_url }}"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (-not (Test-Path $asset_path)) {
          Write-Error "æ‰¾ä¸åˆ°è¦ä¸Šä¼ çš„æ–‡ä»¶: $asset_path"
          exit 1
        }
        
        try {
          $headers = @{
            'Authorization' = 'token ${{ secrets.GITHUB_TOKEN }}'
            'Content-Type' = 'application/octet-stream'
          }
          
          # æ£€æŸ¥Releaseä¸­æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶
          $release_id = "${{ steps.create_release.outputs.id }}"
          $assets_url = "https://api.github.com/repos/${{ github.repository }}/releases/$release_id/assets"
          
          Write-Host "æ£€æŸ¥ç°æœ‰æ–‡ä»¶..."
          try {
            $existing_assets = Invoke-RestMethod -Uri $assets_url -Headers @{
              'Authorization' = 'token ${{ secrets.GITHUB_TOKEN }}'
              'Accept' = 'application/vnd.github.v3+json'
            }
            
            $existing_asset = $existing_assets | Where-Object { $_.name -eq $asset_name }
            
            if ($existing_asset) {
              Write-Host "æ–‡ä»¶ $asset_name å·²å­˜åœ¨äºReleaseä¸­ï¼Œåˆ é™¤æ—§ç‰ˆæœ¬"
              $delete_url = "https://api.github.com/repos/${{ github.repository }}/releases/assets/$($existing_asset.id)"
              Invoke-RestMethod -Uri $delete_url -Method DELETE -Headers @{
                'Authorization' = 'token ${{ secrets.GITHUB_TOKEN }}'
              }
              Write-Host "æ—§ç‰ˆæœ¬å·²åˆ é™¤"
            } else {
              Write-Host "æ–‡ä»¶ $asset_name ä¸å­˜åœ¨ï¼Œå‡†å¤‡ä¸Šä¼ æ–°æ–‡ä»¶"
            }
          } catch {
            Write-Host "æ£€æŸ¥ç°æœ‰æ–‡ä»¶æ—¶å‡ºé”™ï¼Œç»§ç»­ä¸Šä¼ : $($_.Exception.Message)"
          }
          
          # å‡†å¤‡ä¸Šä¼ URL
          $upload_url_clean = $upload_url -replace '\{\?name,label\}', "?name=$asset_name"
          Write-Host "ä¸Šä¼ URL: $upload_url_clean"
          
          # è¯»å–æ–‡ä»¶å¹¶ä¸Šä¼ 
          $file_bytes = [System.IO.File]::ReadAllBytes((Resolve-Path $asset_path))
          Write-Host "æ–‡ä»¶å¤§å°: $([math]::Round($file_bytes.Length/1KB, 2)) KB"
          
          $response = Invoke-RestMethod -Uri $upload_url_clean -Method POST -Headers $headers -Body $file_bytes
          
          Write-Host "âœ“ æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: $asset_name"
          Write-Host "  ä¸‹è½½URL: $($response.browser_download_url)"
          Write-Host "  æ–‡ä»¶å¤§å°: $([math]::Round($response.size/1KB, 2)) KB"
          
        } catch {
          Write-Error "ä¸Šä¼ æ–‡ä»¶å¤±è´¥: $($_.Exception.Message)"
          Write-Error "çŠ¶æ€ç : $($_.Exception.Response.StatusCode)"
          Write-Error "çŠ¶æ€æè¿°: $($_.Exception.Response.StatusDescription)"
          
          if ($_.Exception.Response) {
            try {
              $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
              $responseBody = $reader.ReadToEnd()
              Write-Error "å“åº”å†…å®¹: $responseBody"
            } catch {
              Write-Host "æ— æ³•è¯»å–å“åº”å†…å®¹"
            }
          }
          exit 1
        }

    - name: Build Summary
      shell: pwsh
      run: |
        $created = "${{ steps.create_release.outputs.created }}"
        $action = if ($created -eq "true") { "åˆ›å»º" } else { "å¤ç”¨" }
        
        Write-Host "ğŸ‰ CUDAç‰ˆæœ¬æ„å»ºå’Œå‘å¸ƒå®Œæˆï¼"
        Write-Host ""
        Write-Host "ğŸ“‹ æ„å»ºæ‘˜è¦:"
        Write-Host "  ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
        Write-Host "  CUDAç‰ˆæœ¬: 12.8"
        Write-Host "  GPUåŠ é€Ÿ: å·²å¯ç”¨"
        Write-Host "  Releaseæ“ä½œ: $action"
        Write-Host "  å‘å¸ƒURL: ${{ steps.create_release.outputs.html_url }}"
        Write-Host ""
        Write-Host "ğŸ“¦ å‘å¸ƒçš„æ–‡ä»¶:"
        Get-ChildItem "release-assets" | ForEach-Object {
          Write-Host "  âœ“ $($_.Name)"
        }
        Write-Host ""
        Write-Host "ğŸ”— ä¸‹è½½é“¾æ¥:"
        Write-Host "  Releaseé¡µé¢: ${{ steps.create_release.outputs.html_url }}"
        Write-Host ""
        Write-Host "âš¡ æ€§èƒ½æå‡:"
        Write-Host "  â€¢ GPUå¹¶è¡Œå“ˆå¸Œè®¡ç®—"
        Write-Host "  â€¢ æ”¯æŒMaxwellåˆ°Blackwellæ¶æ„"
        Write-Host "  â€¢ è‡ªåŠ¨CPU/GPUæ¨¡å¼åˆ‡æ¢"
