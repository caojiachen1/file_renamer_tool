name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€å½¢å¦‚ v1.0.0 çš„æ ‡ç­¾
    branches:
      - main
      - master  # æ”¯æŒé€šè¿‡commitä¿¡æ¯è‡ªåŠ¨è§¦å‘release
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬æ›´æ–°ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (ä¾‹å¦‚: v2.0.1, ç•™ç©ºåˆ™è‡ªåŠ¨é€’å¢)'
        required: false
        default: ''

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup CMake
      uses: lukka/get-cmake@latest
      
    - name: Get version from tag or input
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          # æ‰‹åŠ¨è§¦å‘çš„æƒ…å†µ
          $custom_version = "${{ github.event.inputs.custom_version }}"
          
          if ($custom_version -and $custom_version.Trim() -ne "") {
            # ä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬å·
            $version = $custom_version.Trim()
            Write-Host "ä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬å·: $version"
          } else {
            # è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·
            $version_type = "${{ github.event.inputs.version_type }}"
            Write-Host "ç‰ˆæœ¬æ›´æ–°ç±»å‹: $version_type"
            
            # ä½¿ç”¨GitHub APIè·å–æœ€æ–°çš„release
            try {
              $headers = @{
                'Authorization' = 'token ${{ secrets.GITHUB_TOKEN }}'
                'Accept' = 'application/vnd.github.v3+json'
              }
              
              $response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest" -Headers $headers -ErrorAction SilentlyContinue
              
              if ($response -and $response.tag_name) {
                $latest_tag = $response.tag_name
                Write-Host "é€šè¿‡APIæ‰¾åˆ°æœ€æ–°releaseæ ‡ç­¾: $latest_tag"
              } else {
                # å¦‚æœæ²¡æœ‰releaseï¼Œå°è¯•è·å–æœ€æ–°çš„tag
                $tags_response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/tags" -Headers $headers -ErrorAction SilentlyContinue
                if ($tags_response -and $tags_response.Length -gt 0) {
                  $latest_tag = $tags_response[0].name
                  Write-Host "é€šè¿‡APIæ‰¾åˆ°æœ€æ–°æ ‡ç­¾: $latest_tag"
                } else {
                  $latest_tag = "v2.0.0"
                  Write-Host "æœªæ‰¾åˆ°ä»»ä½•æ ‡ç­¾ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $latest_tag"
                }
              }
            } catch {
              # å›é€€åˆ°gitå‘½ä»¤
              Write-Host "APIè°ƒç”¨å¤±è´¥ï¼Œå›é€€åˆ°gitå‘½ä»¤"
              $latest_tag = git describe --tags --abbrev=0 2>$null
              if (-not $latest_tag) {
                $latest_tag = "v2.0.0"
                Write-Host "æœªæ‰¾åˆ°ç°æœ‰æ ‡ç­¾ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $latest_tag"
              } else {
                Write-Host "é€šè¿‡gitæ‰¾åˆ°æœ€æ–°æ ‡ç­¾: $latest_tag"
              }
            }
            
            # è§£æç‰ˆæœ¬å·
            if ($latest_tag -match '^v(\d+)\.(\d+)\.(\d+)$') {
              $major = [int]$matches[1]
              $minor = [int]$matches[2]
              $patch = [int]$matches[3]
              
              # æ ¹æ®ç±»å‹é€’å¢ç‰ˆæœ¬å·
              switch ($version_type) {
                "major" { 
                  $major++
                  $minor = 0
                  $patch = 0
                }
                "minor" { 
                  $minor++
                  $patch = 0
                }
                "patch" { 
                  $patch++
                }
              }
              
              $version = "v$major.$minor.$patch"
              Write-Host "è‡ªåŠ¨é€’å¢åçš„ç‰ˆæœ¬: $version"
            } else {
              Write-Error "æ— æ³•è§£æç‰ˆæœ¬å·æ ¼å¼: $latest_tag"
              exit 1
            }
          }
        } else {
          # æ¨é€è§¦å‘çš„æƒ…å†µ (æ ‡ç­¾æ¨é€æˆ–åˆ†æ”¯æ¨é€)
          if ("${{ github.ref_type }}" -eq "tag") {
            # æ ‡ç­¾æ¨é€è§¦å‘
            $version = "${{ github.ref_name }}"
            Write-Host "ä»æ ‡ç­¾è·å–ç‰ˆæœ¬: $version"
          } else {
            # åˆ†æ”¯æ¨é€è§¦å‘ - æ£€æŸ¥commitä¿¡æ¯æ¥ç¡®å®šæ˜¯å¦éœ€è¦è‡ªåŠ¨å‘å¸ƒ
            $commit_message = git log -1 --pretty=format:"%s%n%b"
            Write-Host "æ£€æŸ¥commitä¿¡æ¯: $commit_message"
            
            # æ£€æŸ¥commitä¿¡æ¯ä¸­çš„ç‰ˆæœ¬æ§åˆ¶å…³é”®è¯
            $auto_version_type = $null
            
            # ä¼˜å…ˆæ£€æŸ¥æœ«å°¾çš„[]æ ‡è®°
            if ($commit_message -match '\[major\]$') {
              $auto_version_type = "major"
            } elseif ($commit_message -match '\[minor\]$') {
              $auto_version_type = "minor"
            } elseif ($commit_message -match '\[patch\]$') {
              $auto_version_type = "patch"
            }
            # å¦‚æœæ²¡æœ‰[]æ ‡è®°ï¼Œå†æ£€æŸ¥å…¶ä»–å…³é”®è¯
            elseif ($commit_message -match '\bmajor:|\bbreaking\s*change|\bBREAKING\s*CHANGE') {
              $auto_version_type = "major"
            } elseif ($commit_message -match '\bminor:|\bfeat:|\bfeature:') {
              $auto_version_type = "minor"
            } elseif ($commit_message -match '\bpatch:|\bfix:|\bbugfix:') {
              $auto_version_type = "patch"
            }
            
            if (-not $auto_version_type) {
              Write-Host "commitä¿¡æ¯ä¸­æœªæ‰¾åˆ°ç‰ˆæœ¬æ§åˆ¶å…³é”®è¯ï¼Œè·³è¿‡è‡ªåŠ¨å‘å¸ƒ"
              Write-Host "æ”¯æŒçš„æ ‡è®°æ ¼å¼:"
              Write-Host "  - æ¶ˆæ¯æœ«å°¾: [major], [minor], [patch]"
              Write-Host "  - å‰ç¼€å…³é”®è¯: major:, minor:, patch:, feat:, fix:, etc."
              Write-Host "å½“å‰commit: $commit_message"
              exit 0
            }
            
            Write-Host "ä»commitä¿¡æ¯æ£€æµ‹åˆ°ç‰ˆæœ¬ç±»å‹: $auto_version_type"
            
            # ä½¿ç”¨GitHub APIè·å–æœ€æ–°çš„releaseæ¥è‡ªåŠ¨è®¡ç®—ç‰ˆæœ¬
            try {
              $headers = @{
                'Authorization' = 'token ${{ secrets.GITHUB_TOKEN }}'
                'Accept' = 'application/vnd.github.v3+json'
              }
              
              $response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest" -Headers $headers -ErrorAction SilentlyContinue
              
              if ($response -and $response.tag_name) {
                $latest_tag = $response.tag_name
                Write-Host "é€šè¿‡APIæ‰¾åˆ°æœ€æ–°releaseæ ‡ç­¾: $latest_tag"
              } else {
                # å¦‚æœæ²¡æœ‰releaseï¼Œå°è¯•è·å–æœ€æ–°çš„tag
                $tags_response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/tags" -Headers $headers -ErrorAction SilentlyContinue
                if ($tags_response -and $tags_response.Length -gt 0) {
                  $latest_tag = $tags_response[0].name
                  Write-Host "é€šè¿‡APIæ‰¾åˆ°æœ€æ–°æ ‡ç­¾: $latest_tag"
                } else {
                  $latest_tag = "v2.0.0"
                  Write-Host "æœªæ‰¾åˆ°ä»»ä½•æ ‡ç­¾ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $latest_tag"
                }
              }
              
              # è§£æå¹¶é€’å¢ç‰ˆæœ¬å·
              if ($latest_tag -match '^v(\d+)\.(\d+)\.(\d+)$') {
                $major = [int]$matches[1]
                $minor = [int]$matches[2]
                $patch = [int]$matches[3]
                
                switch ($auto_version_type) {
                  "major" { 
                    $major++
                    $minor = 0
                    $patch = 0
                  }
                  "minor" { 
                    $minor++
                    $patch = 0
                  }
                  "patch" { 
                    $patch++
                  }
                }
                
                $version = "v$major.$minor.$patch"
                Write-Host "åŸºäºcommitä¿¡æ¯è‡ªåŠ¨é€’å¢ç‰ˆæœ¬: $latest_tag â†’ $version"
              } else {
                Write-Error "æ— æ³•è§£æç‰ˆæœ¬å·æ ¼å¼: $latest_tag"
                exit 1
              }
            } catch {
              Write-Error "APIè°ƒç”¨å¤±è´¥ï¼Œæ— æ³•è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬"
              exit 1
            }
          }
        }
        
        # ç¡®ä¿ç‰ˆæœ¬æ ¼å¼æ­£ç¡® (vä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬)
        if ($version -notmatch '^v\d+\.\d+\.\d+$') {
          Write-Error "ç‰ˆæœ¬æ ¼å¼é”™è¯¯ã€‚è¯·ä½¿ç”¨ vä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬ æ ¼å¼ (ä¾‹å¦‚: v2.0.1)"
          Write-Error "å½“å‰ç‰ˆæœ¬: $version"
          exit 1
        }
        
        Write-Output "version=$version" >> $env:GITHUB_OUTPUT
        Write-Output "version_number=$($version.Substring(1))" >> $env:GITHUB_OUTPUT
        Write-Host "æœ€ç»ˆç‰ˆæœ¬: $version"
        
    - name: Update version in CMakeLists.txt
      shell: pwsh
      run: |
        $version_number = "${{ steps.version.outputs.version_number }}"
        $cmake_content = Get-Content CMakeLists.txt -Raw
        $cmake_content = $cmake_content -replace 'project\(FileRenamerTool VERSION \d+\.\d+\.\d+', "project(FileRenamerTool VERSION $version_number"
        Set-Content CMakeLists.txt $cmake_content
        Write-Host "å·²æ›´æ–° CMakeLists.txt ä¸­çš„ç‰ˆæœ¬å·ä¸º: $version_number"
        
    - name: Create and push tag (for manual trigger and auto release)
      if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref_type == 'branch')
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        
        # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        $existing_tag = git tag -l $version
        if ($existing_tag) {
          Write-Host "æ ‡ç­¾ $version å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
        } else {
          Write-Host "åˆ›å»ºæ–°æ ‡ç­¾: $version"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag $version
          git push origin $version
          Write-Host "æ ‡ç­¾ $version å·²åˆ›å»ºå¹¶æ¨é€"
        }
        
    - name: Build project
      shell: cmd
      run: |
        echo å¼€å§‹æ„å»ºé¡¹ç›®...
        call build.bat
        if %errorlevel% neq 0 (
          echo æ„å»ºå¤±è´¥ï¼
          exit /b %errorlevel%
        )
        echo æ„å»ºå®Œæˆï¼
        
    - name: Verify build artifacts
      shell: pwsh
      run: |
        Write-Host "æ£€æŸ¥æ„å»ºäº§ç‰©..."
        
        $release_exe = "build\Release\file_renamer_cli.exe"
        $debug_exe = "build\Debug\file_renamer_cli_d.exe"
        $root_exe = "file_renamer_cli.exe"
        
        if (Test-Path $release_exe) {
          Write-Host "âœ“ æ‰¾åˆ° Release ç‰ˆæœ¬: $release_exe"
          $size = (Get-Item $release_exe).Length
          Write-Host "  æ–‡ä»¶å¤§å°: $([math]::Round($size/1KB, 2)) KB"
        } else {
          Write-Error "âœ— æœªæ‰¾åˆ° Release ç‰ˆæœ¬: $release_exe"
          exit 1
        }
        
        if (Test-Path $debug_exe) {
          Write-Host "âœ“ æ‰¾åˆ° Debug ç‰ˆæœ¬: $debug_exe"
        } else {
          Write-Host "âš  æœªæ‰¾åˆ° Debug ç‰ˆæœ¬: $debug_exe"
        }
        
        if (Test-Path $root_exe) {
          Write-Host "âœ“ æ‰¾åˆ°æ ¹ç›®å½•å‰¯æœ¬: $root_exe"
        } else {
          Write-Host "âš  æœªæ‰¾åˆ°æ ¹ç›®å½•å‰¯æœ¬: $root_exe"
        }
        
    - name: Prepare release assets
      shell: pwsh
      run: |
        Write-Host "å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "release-assets"
        
        # å¤åˆ¶ä¸»è¦å¯æ‰§è¡Œæ–‡ä»¶
        $version = "${{ steps.version.outputs.version }}"
        $release_name = "file_renamer_cli_$($version)_windows_x64.exe"
        Copy-Item "build\Release\file_renamer_cli.exe" "release-assets\$release_name"
        
        Write-Host "å‘å¸ƒæ–‡ä»¶å‡†å¤‡å®Œæˆï¼š"
        Get-ChildItem "release-assets" | ForEach-Object {
          Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1KB, 2)) KB)"
        }
        
    - name: Create release notes
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        
        # è·å–æœ€æ–°çš„commitä¿¡æ¯
        $commit_message = git log -1 --pretty=format:"%s"
        $commit_body = git log -1 --pretty=format:"%b"
        $commit_hash = git log -1 --pretty=format:"%h"
        
        # åˆ›å»ºç®€æ´çš„å‘å¸ƒè¯´æ˜
        $content = @()
        $content += "## ğŸ“¦ File Renamer CLI Tool $version"
        $content += ""
        
        # æ·»åŠ commitä¿¡æ¯
        if ($commit_message) {
          $content += "- $commit_message"
          if ($commit_body -and $commit_body.Trim() -ne "") {
            $commit_body.Split("`n") | ForEach-Object {
              if ($_.Trim() -ne "") {
                $content += "- $($_.Trim())"
              }
            }
          }
          $content += ""
          $content += "*Commit: $commit_hash*"
          $content += ""
        }
        
        # æ·»åŠ ä½¿ç”¨è¯´æ˜
        $content += "ä½¿ç”¨æ–¹æ³•"
        $content += ""
        $content += "**é¢„è§ˆæ¨¡å¼**"
        $content += '```cmd'
        $content += 'file_renamer_cli.exe "C:\MyFiles" -x jpg,png'
        $content += '```'
        $content += ""
        $content += "**æ‰§è¡Œé‡å‘½åï¼š**"
        $content += '```cmd'
        $content += 'file_renamer_cli.exe "C:\MyFiles" -x jpg,png -e'
        $content += '```'
        $content += ""
        $content += "**æ›´å¤šé€‰é¡¹ï¼š**"
        $content += '```cmd'
        $content += 'file_renamer_cli.exe --help'
        $content += '```'
        $content += ""
        $content += "ç³»ç»Ÿè¦æ±‚"
        $content += "- Windows 10/11 (x64)"
        
        $content | Out-File "release-notes.md" -Encoding UTF8
        Write-Host "å‘å¸ƒè¯´æ˜å·²ç”Ÿæˆ"
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version }}
        release_name: File Renamer CLI Tool ${{ steps.version.outputs.version }}
        body_path: release-notes.md
        draft: false
        prerelease: false
        
    - name: Upload Release Asset - Main Executable
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: release-assets/file_renamer_cli_${{ steps.version.outputs.version }}_windows_x64.exe
        asset_name: file_renamer_cli_${{ steps.version.outputs.version }}_windows_x64.exe
        asset_content_type: application/octet-stream

    - name: Build Summary
      shell: pwsh
      run: |
        Write-Host "ğŸ‰ æ„å»ºå’Œå‘å¸ƒå®Œæˆï¼"
        Write-Host ""
        Write-Host "ğŸ“‹ æ„å»ºæ‘˜è¦:"
        Write-Host "  ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
        Write-Host "  å‘å¸ƒURL: ${{ steps.create_release.outputs.html_url }}"
        Write-Host ""
        Write-Host "ğŸ“¦ å‘å¸ƒçš„æ–‡ä»¶:"
        Get-ChildItem "release-assets" | ForEach-Object {
          Write-Host "  âœ“ $($_.Name)"
        }
        Write-Host ""
        Write-Host "ğŸ”— ä¸‹è½½é“¾æ¥:"
        Write-Host "  Releaseé¡µé¢: ${{ steps.create_release.outputs.html_url }}"
